---
name: Convex Backend - Schema & Functions
status: closed
created: 2026-02-09T03:56:28Z
updated: 2026-02-09T04:09:38Z
github: https://github.com/SecondSaturday/second-saturday/issues/44
depends_on: []
parallel: false
conflicts_with: []
---

# Task: Convex Backend - Schema & Functions

## Description

Set up the Convex schema and implement all queries/mutations needed for circles, prompts, memberships, and newsletter read tracking. This is the foundation that all other tasks depend on.

## Acceptance Criteria

- [x] `circles` table created with all required fields and indexes
- [x] `prompts` table created with circle relationship and ordering
- [x] `memberships` table created (if not already from Epic 1)
- [x] `newsletterReads` table created for read/unread tracking
- [x] `createCircle` mutation works with auto-generated invite code and default prompts
- [x] `updateCircle` mutation updates name, images, description
- [x] `regenerateInviteCode` mutation creates new UUID
- [x] `getCirclesByUser` query returns circles with member previews and unread status
- [x] `getCirclePrompts` query returns ordered prompts for a circle
- [x] `updatePrompts` mutation handles add, remove, reorder operations
- [x] `markNewsletterRead` mutation records read timestamp
- [x] `getNewslettersByDate` query filters newsletters by month
- [x] All functions have proper authorization checks (user must be member/admin)
- [x] Validation: circle name 3-50 chars, prompt text max 200 chars

## Technical Details

### Schema (convex/schema.ts)

```typescript
circles: defineTable({
  name: v.string(),
  iconImageId: v.optional(v.id("_storage")),
  coverImageId: v.optional(v.id("_storage")),
  description: v.optional(v.string()),
  adminId: v.id("users"),
  inviteCode: v.string(),
  timezone: v.string(),
  archivedAt: v.optional(v.number()),
})
  .index("by_admin", ["adminId"])
  .index("by_invite_code", ["inviteCode"])

prompts: defineTable({
  circleId: v.id("circles"),
  text: v.string(),
  order: v.number(),
  active: v.boolean(),
})
  .index("by_circle", ["circleId"])

memberships: defineTable({
  userId: v.id("users"),
  circleId: v.id("circles"),
  role: v.union(v.literal("admin"), v.literal("member")),
  joinedAt: v.number(),
})
  .index("by_user", ["userId"])
  .index("by_circle", ["circleId"])

newsletterReads: defineTable({
  userId: v.id("users"),
  circleId: v.id("circles"),
  newsletterId: v.id("newsletters"),
  readAt: v.number(),
})
  .index("by_user_circle", ["userId", "circleId"])
```

### Files to Create/Modify

- `convex/schema.ts` - Add new tables
- `convex/circles.ts` - Circle mutations and queries
- `convex/prompts.ts` - Prompt mutations and queries
- `convex/memberships.ts` - Membership queries (if not exists)
- `convex/newsletterReads.ts` - Read tracking

### Default Prompts

When creating a circle, auto-create these 4 prompts:
1. "What did you do this month?"
2. "One Good Thing"
3. "On Your Mind"
4. "What are you listening to?"

## Dependencies

- [x] Epic 0 complete (Convex configured)
- [x] Epic 1 complete (users table exists)

## Effort Estimate

- Size: M
- Hours: 4-6
- Parallel: false (other tasks depend on this)

## Definition of Done

- [x] Schema deployed to Convex dev environment
- [x] All queries return expected data shape
- [x] All mutations work with proper validation
- [x] Authorization checks prevent unauthorized access
- [x] Manual testing via Convex dashboard confirms functionality
- [x] No TypeScript errors

---
name: Build newsletter send action and cron job
status: open
created: 2026-02-21T09:57:44Z
updated: 2026-02-21T10:10:10Z
github: https://github.com/SecondSaturday/second-saturday/issues/96
depends_on: [93, 94, 95]
parallel: false
conflicts_with: [93]
---

# Task: Build Newsletter Send Action and Cron Job

## Description
Create the `sendNewsletter` internal action that sends compiled newsletters via Resend to all active circle members (respecting unsubscribe preferences). Create the `sendMissedMonthEmail` action. Set up the Convex cron job that triggers newsletter compilation and sending after the deadline.

## Acceptance Criteria
- [ ] `sendNewsletter` internal action created (accepts newsletterId)
- [ ] Gets all active circle members (not left, not blocked)
- [ ] Filters out members with `emailUnsubscribed: true`
- [ ] Renders `NewsletterEmail` React component to HTML via React Email `render()`
- [ ] Sends email to each member via Resend API
- [ ] Updates newsletter `recipientCount` after sending
- [ ] `sendMissedMonthEmail` action sends `MissedMonthEmail` when 0 submissions
- [ ] Cron job added to `convex/crons.ts` at 11:00 AM UTC second Saturdays
- [ ] Cron triggers compilation → checks result → sends newsletter OR missed-month email
- [ ] Handles errors gracefully (logs failures, doesn't crash cron)

## Technical Details
- Add to `convex/newsletters.ts` with `'use node'` directive (needed for Resend)
- Follow pattern from `convex/emails.ts`: `internalAction` with Resend API
- Use `@react-email/components` `render()` function to convert React template to HTML string
- Cron expression for second Saturday: use a helper that checks if today is the second Saturday of the month (cron runs weekly on Saturdays, but action checks date before proceeding)
- Cron schedule: `'0 11 * * 6'` (11:00 AM UTC every Saturday) with second-Saturday check inside the action
- FROM address: `process.env.RESEND_FROM_EMAIL || 'noreply@secondsaturday.app'`
- Get all circles, iterate each, compile and send per circle
- Use `ctx.scheduler.runAfter` for async fan-out if needed

## Dependencies
- [ ] Task 93: Schema with emailUnsubscribed field
- [ ] Task 94: compileNewsletter action must exist
- [ ] Task 95: React Email templates must exist

## Effort Estimate
- Size: M
- Hours: 3
- Parallel: false (depends on 93, 94, 95)

## Definition of Done
- [ ] Newsletter emails send successfully via Resend
- [ ] Unsubscribed members do not receive email
- [ ] Missed-month email sends when 0 submissions
- [ ] Cron job registered in `convex/crons.ts`
- [ ] Cron correctly identifies second Saturdays
- [ ] Error handling prevents cron crashes

---
name: Build newsletter compilation action
status: open
created: 2026-02-21T09:57:44Z
updated: 2026-02-21T10:10:10Z
github: https://github.com/SecondSaturday/second-saturday/issues/94
depends_on: [93]
parallel: false
conflicts_with: []
---

# Task: Build Newsletter Compilation Action

## Description
Create the `compileNewsletter` internal action in Convex that gathers all submissions for a circle's current cycle, organizes them by prompt, generates HTML content, and stores the compiled newsletter. This is the core business logic that turns raw submissions into a readable newsletter.

## Acceptance Criteria
- [ ] `compileNewsletter` internal action created that accepts `circleId` and `cycleId`
- [ ] Gathers all locked submissions for the given circle and cycle
- [ ] Organizes responses by prompt (using prompt order)
- [ ] Omits empty prompts (prompts with zero responses)
- [ ] Includes member names, text responses, and media references (photos + Mux video thumbnails)
- [ ] Generates HTML content string suitable for both email and web rendering
- [ ] Creates newsletter record with `htmlContent`, `cycleId`, `issueNumber` (auto-increment), `submissionCount`, `memberCount`
- [ ] Sets newsletter status to `published` and `publishedAt` timestamp
- [ ] Detects 0-submission case and flags for missed-month handling
- [ ] Returns newsletter ID for downstream send action

## Technical Details
- Create in `convex/newsletters.ts` as `internalAction` or `internalMutation`
- Query submissions via `submissions` table with `by_user_circle_cycle` index
- Query responses via `responses` table with `by_submission_prompt` index
- Query media via `media` table for each response
- Query prompts via `prompts` table with `by_circle` index, filtered to `active: true`
- For video media: generate Mux thumbnail URL using existing pattern from `convex/videos.ts`
- For photo media: use Convex storage URL
- `issueNumber`: count existing newsletters for this circle + 1
- HTML generation: use template literals with inline CSS (will be rendered by React Email in Task 95)

## Dependencies
- [ ] Task 93: Schema extensions must be in place

## Effort Estimate
- Size: M
- Hours: 4
- Parallel: false (depends on 93)

## Definition of Done
- [ ] Compilation action works with real submission data
- [ ] Empty prompts correctly omitted
- [ ] Media URLs resolve correctly (photos and video thumbnails)
- [ ] Newsletter record stored with all required fields
- [ ] 0-submission edge case handled

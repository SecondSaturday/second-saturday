---
name: Secure user and membership queries
status: open
created: 2026-02-24T16:13:00Z
updated: 2026-02-24T16:18:16Z
github: https://github.com/SecondSaturday/second-saturday/issues/158
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Secure user and membership queries

## Description

Convert `getUserByClerkId` and `getMembershipCount` from public queries to internal queries to prevent unauthorized access. These functions are only called from other Convex functions and webhooks, not from the frontend.

## Acceptance Criteria

- [ ] `getUserByClerkId` in `convex/users.ts` converted from `query` to `internalQuery`
- [ ] `getMembershipCount` in `convex/memberships.ts` converted from `query` to `internalQuery`
- [ ] No frontend code imports or calls these functions directly (verified before converting)
- [ ] All internal callers updated to use `internal.users.getUserByClerkId` and `internal.memberships.getMembershipCount` syntax if needed
- [ ] Application still functions correctly after conversion

## Technical Details

### Pre-conversion verification
Before converting, grep the frontend (`src/`) for any imports of:
- `getUserByClerkId` from `convex/users`
- `getMembershipCount` from `convex/memberships`

If any frontend callers exist, add auth checks instead of converting to internal.

### `convex/users.ts` — `getUserByClerkId`
- Change `export const getUserByClerkId = query({` to `export const getUserByClerkId = internalQuery({`
- Add `import { internalQuery } from './_generated/server'` if not already imported
- Update any internal callers that reference this via `api.users.getUserByClerkId` to use `internal.users.getUserByClerkId`

### `convex/memberships.ts` — `getMembershipCount`
- Change `export const getMembershipCount = query({` to `export const getMembershipCount = internalQuery({`
- Add `import { internalQuery } from './_generated/server'` if not already imported
- Update any internal callers that reference this via `api.memberships.getMembershipCount` to use `internal.memberships.getMembershipCount`

### Files affected
- `convex/users.ts`
- `convex/memberships.ts`
- Any files that call these functions (need to verify)

## Dependencies
- [ ] None — independent of all other tasks

## Effort Estimate
- Size: S
- Parallel: true

## Definition of Done
- [ ] Both functions converted to `internalQuery`
- [ ] No frontend code references these functions
- [ ] All internal callers updated
- [ ] Existing tests pass (`npm test`)
- [ ] Convex generates updated API types without errors

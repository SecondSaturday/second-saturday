---
name: Secure video functions with auth
status: open
created: 2026-02-24T16:13:00Z
updated: 2026-02-24T16:18:16Z
github: https://github.com/SecondSaturday/second-saturday/issues/157
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Secure video functions with auth

## Description

Add authentication and authorization checks to all 4 public functions in `convex/videos.ts` following the existing `getAuthUser`/`requireMembership` pattern. Remove the client-supplied `userId` parameter from `createVideo` and extract it from auth context. Update the single frontend caller.

## Acceptance Criteria

- [ ] `createVideo`: Removes `userId` arg, extracts user from `ctx.auth.getUserIdentity()` via `getAuthUser` helper, rejects unauthenticated calls
- [ ] `getVideo`: Adds auth check, verifies caller is video owner or member of the video's circle
- [ ] `getVideosByUser`: Adds auth check, restricts to caller's own videos only
- [ ] `deleteVideo`: Adds auth check, verifies caller is video owner
- [ ] `MediaUploader.tsx` updated to remove `userId` argument from `createVideo` call
- [ ] All internal mutations (`updateVideoAsset`, `updateVideoReady`, `updateVideoError`) remain unchanged (already internal)

## Technical Details

### Add helpers to `convex/videos.ts`
Copy the `getAuthUser` and `requireMembership` helpers from `convex/submissions.ts` into `convex/videos.ts` (matches codebase convention of per-file helpers).

### `createVideo` changes
- Remove `userId: v.string()` from args
- Add at top of handler: `const user = await getAuthUser(ctx)`
- Use `user.clerkId` (or `user._id` depending on what the `userId` field stores) instead of `args.userId`
- Verify what format `userId` is stored as in the videos table (clerkId string vs Convex Id)

### `getVideo` changes
- Add `const user = await getAuthUser(ctx)` at top
- After fetching video, verify: `video.userId === user.clerkId` OR if video has `circleId`, verify membership via `requireMembership(ctx, user._id, video.circleId)`

### `getVideosByUser` changes
- Remove `userId: v.string()` from args
- Add `const user = await getAuthUser(ctx)`
- Query using `user.clerkId` instead of `args.userId`

### `deleteVideo` changes
- Add `const user = await getAuthUser(ctx)` at top
- Fetch the video first, verify `video.userId === user.clerkId`
- Throw if not owner

### Frontend caller: `src/components/submissions/MediaUploader.tsx`
- Find the `createVideo` call and remove the `userId` argument
- This is the only frontend caller (verified via grep)

### Files affected
- `convex/videos.ts`
- `src/components/submissions/MediaUploader.tsx`

## Dependencies
- [ ] None — independent of all other tasks

## Effort Estimate
- Size: L
- Parallel: true
- Note: Largest task in the epic — 4 function rewrites + 1 caller update

## Definition of Done
- [ ] All 4 public video functions have auth checks
- [ ] `createVideo` no longer accepts `userId` as a parameter
- [ ] Frontend caller updated
- [ ] Existing tests pass (`npm test`)
- [ ] Unauthenticated calls to video functions throw "Not authenticated"

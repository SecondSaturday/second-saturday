---
name: Code cleanup and hygiene fixes
status: open
created: 2026-02-24T16:13:00Z
updated: 2026-02-24T16:18:16Z
github: https://github.com/SecondSaturday/second-saturday/issues/161
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Code cleanup and hygiene fixes

## Description

Remove debug console.log statements that leak sensitive data, delete the demo page, fix the ObjectURL memory leak, and handle orphaned media on Mux processing failure.

## Acceptance Criteria

- [ ] D1: All `console.log` in `src/lib/onesignal.ts` removed (especially lines 89 and 103 that leak App ID and subscription ID). Keep `console.error` in catch blocks.
- [ ] D2: All debug `console.log` removed from: `src/providers/capacitor-provider.tsx` (3 logs), `src/lib/image.ts:48` (1 log), `src/providers/onesignal-provider.tsx:71` (1 log)
- [ ] D3: `src/app/demo-submissions/page.tsx` deleted entirely
- [ ] D4: `src/components/circles/ImageUpload.tsx` revokes previous ObjectURL before creating new one
- [ ] A5: `convex/http.ts` handles `video.asset.errored` Mux webhook to delete orphaned media records

## Technical Details

### D1-D2: Console log removal
- `src/lib/onesignal.ts`: Remove all 6 `console.log` statements. The ones at lines 89 and 103 leak the OneSignal App ID and subscription ID.
- `src/providers/capacitor-provider.tsx`: Remove all 3 `console.log` statements
- `src/lib/image.ts`: Remove `console.log` at line 48
- `src/providers/onesignal-provider.tsx`: Remove `console.log` at line 71
- Keep all `console.error` and `console.warn` — only remove `console.log`

### D3: Demo page deletion
- Delete `src/app/demo-submissions/page.tsx` entirely
- Check if there's a layout.tsx or other files in that directory that should also be removed

### D4: ObjectURL memory leak (`src/components/circles/ImageUpload.tsx`)
- Line 72: Before `setPreview(URL.createObjectURL(file))`, add:
  ```
  if (preview) URL.revokeObjectURL(preview)
  ```
- Also add cleanup in a `useEffect` return for component unmount

### A5: Orphan media cleanup (`convex/http.ts`)
- Find the existing Mux webhook handler
- Add a case for `video.asset.errored` event type
- When received, find the media record by `uploadId` or `assetId` and delete it
- Look at the existing webhook handler pattern for `video.asset.ready` to match the structure

### Files affected
- `src/lib/onesignal.ts`
- `src/providers/capacitor-provider.tsx`
- `src/lib/image.ts`
- `src/providers/onesignal-provider.tsx`
- `src/app/demo-submissions/page.tsx` (delete)
- `src/components/circles/ImageUpload.tsx`
- `convex/http.ts`

## Dependencies
- [ ] None — independent of all other tasks

## Effort Estimate
- Size: M
- Parallel: true
- Note: Many small changes across many files, but each is straightforward

## Definition of Done
- [ ] Zero `console.log` in the listed files (grep verification)
- [ ] Demo page returns 404
- [ ] ObjectURL properly cleaned up
- [ ] Orphaned media deleted on Mux error webhook
- [ ] Existing tests pass (`npm test`)

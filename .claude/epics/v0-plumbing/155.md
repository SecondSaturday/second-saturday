---
name: Fix P0 data bugs
status: open
created: 2026-02-24T16:13:00Z
updated: 2026-02-24T16:18:16Z
github: https://github.com/SecondSaturday/second-saturday/issues/155
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Fix P0 data bugs

## Description

Fix three P0 data integrity bugs: newsletter duplication on cron retry, timezone-dependent cycleId computation, and auto-save racing with submission lock.

## Acceptance Criteria

- [ ] `compileNewsletter` in `convex/newsletters.ts` queries for existing newsletter by `circleId + cycleId` before inserting; returns existing newsletter ID if found
- [ ] `src/app/dashboard/circles/[circleId]/submit/page.tsx` uses `getUTCFullYear()` and `getUTCMonth()` instead of `getFullYear()` and `getMonth()` for cycleId computation
- [ ] `MultiCircleSubmissionScreen.tsx` cancels/guards the debounced auto-save when the user clicks Submit, preventing race between auto-save and `lockSubmission`
- [ ] No duplicate newsletters can be created for the same `circleId + cycleId`
- [ ] CycleId matches server-side UTC convention
- [ ] No false error shown after successful submission

## Technical Details

### FR1: Newsletter Idempotency (`convex/newsletters.ts`)
- In `compileNewsletter` (internal mutation), add a query at the top of the handler:
  ```
  const existing = await ctx.db.query('newsletters')
    .withIndex('by_circle_cycle', q => q.eq('circleId', args.circleId).eq('cycleId', args.cycleId))
    .first()
  if (existing) return existing._id
  ```
- If no `by_circle_cycle` index exists, check schema and add one, or use a filter query
- This is the only P0 with backend-only changes

### FR2: UTC CycleId (`src/app/dashboard/circles/[circleId]/submit/page.tsx`)
- Lines 17-19: Change `new Date().getFullYear()` to `new Date().getUTCFullYear()` and `getMonth()` to `getUTCMonth()`
- Single line change, zero risk

### FR3: Auto-save Race (`src/screens/submissions/MultiCircleSubmissionScreen.tsx`)
- Lines 137-219: The `useDebounce` + `useEffect` pattern fires auto-save 2000ms after last change
- In `handleSubmit` (lines 72-83): Add a ref (e.g., `isLockedRef`) set to `true` before calling `lockSubmission`
- In the debounced save effect: Check `isLockedRef.current` and bail out if true
- Alternative: cancel the debounce timer directly if the debounce hook exposes a cancel function

### Files affected
- `convex/newsletters.ts`
- `src/app/dashboard/circles/[circleId]/submit/page.tsx`
- `src/screens/submissions/MultiCircleSubmissionScreen.tsx`

## Dependencies
- [ ] None â€” can start immediately

## Effort Estimate
- Size: M
- Parallel: true
- Note: Three independent sub-fixes bundled as one task because they are all P0 priority

## Definition of Done
- [ ] Code implemented for all three fixes
- [ ] Existing tests pass (`npm test`)
- [ ] Manual verification: newsletter cron retry doesn't duplicate, cycleId is UTC, submit doesn't show false error

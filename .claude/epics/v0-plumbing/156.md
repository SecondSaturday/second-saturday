---
name: Fix cron locked-status derivation
status: open
created: 2026-02-24T16:13:00Z
updated: 2026-02-24T16:18:16Z
github: https://github.com/SecondSaturday/second-saturday/issues/156
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Fix cron locked-status derivation

## Description

Fix the cron auto-lock to stop setting `submittedAt` when the user never explicitly submitted, and update the frontend status derivation to distinguish user-submitted from cron-locked submissions.

## Acceptance Criteria

- [ ] Cron in `convex/crons.ts` only sets `lockedAt` (not `submittedAt`) when auto-locking submissions where the user never submitted
- [ ] If user already submitted (`submittedAt` exists), cron preserves the existing `submittedAt` value
- [ ] Frontend status derivation in `submit/page.tsx` correctly shows:
  - `'submitted'` when `submittedAt` exists and was set by the user
  - `'locked'` when only `lockedAt` exists (cron auto-locked, user never submitted)

## Technical Details

### Backend: `convex/crons.ts`
- Line 36: Change `submittedAt: submission.submittedAt ?? now` to conditionally include `submittedAt` only when it already exists
- New logic:
  ```
  const patch: any = { lockedAt: now, updatedAt: now }
  if (submission.submittedAt) {
    patch.submittedAt = submission.submittedAt  // preserve existing
  }
  await ctx.db.patch(submission._id, patch)
  ```
- This means cron-locked submissions where user never submitted will have `lockedAt` but no `submittedAt`

### Frontend: `src/app/dashboard/circles/[circleId]/submit/page.tsx`
- Lines 41-45: Update status derivation logic
- Current logic likely checks only `submittedAt` — update to:
  - If `submittedAt` exists → `'submitted'`
  - Else if `lockedAt` exists → `'locked'`
  - Else → current default (draft/in-progress)

### Files affected
- `convex/crons.ts`
- `src/app/dashboard/circles/[circleId]/submit/page.tsx`

## Dependencies
- [ ] None — independent of all other tasks

## Effort Estimate
- Size: S
- Parallel: true

## Definition of Done
- [ ] Code implemented for both backend and frontend changes
- [ ] Existing tests pass (`npm test`)
- [ ] Status correctly distinguishes user-submitted vs cron-locked

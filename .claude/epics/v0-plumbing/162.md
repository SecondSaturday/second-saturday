---
name: Add tests for new logic
status: open
created: 2026-02-24T16:13:00Z
updated: 2026-02-24T16:18:16Z
github: https://github.com/SecondSaturday/second-saturday/issues/162
depends_on: [155, 156, 157, 160]
parallel: false
conflicts_with: []
---

# Task: Add tests for new logic

## Description

Add unit tests covering the new logic introduced by this epic: newsletter idempotency guard, video function auth checks, validation logic, and UTC cycleId computation. All existing 926 tests must continue to pass.

## Acceptance Criteria

- [ ] Test for newsletter idempotency: verify `compileNewsletter` returns existing newsletter ID when called twice with same `circleId + cycleId`
- [ ] Test for UTC cycleId: verify cycleId computation uses UTC methods and produces correct values near month boundaries
- [ ] Test for video auth: verify unauthenticated calls to video functions throw "Not authenticated"
- [ ] Test for validation: verify profile name rejects empty string, circle name rejects strings < 3 chars
- [ ] All existing tests still pass
- [ ] Test files follow existing Vitest patterns in `test/unit/`

## Technical Details

### Test framework
- Vitest with jsdom environment
- Setup file: `test/setup.ts`
- Pattern: `describe` / `it` / `expect` from vitest
- Location: `test/unit/` directory

### Newsletter idempotency test
- Extract the idempotency check logic into a testable pure function if possible
- Or test at the integration level by calling the mutation twice
- File: `test/unit/newsletter-idempotency.test.ts`

### UTC cycleId test
- Extract cycleId computation into a utility function if not already
- Test with dates near month boundaries in various timezones
- File: `test/unit/cycle-id.test.ts`

### Video auth tests
- Test that the auth helper pattern correctly rejects unauthenticated contexts
- May need to mock `ctx.auth.getUserIdentity()` returning null
- File: `test/unit/video-auth.test.ts`

### Validation tests
- Test profile name validation: empty string, whitespace-only, valid name
- Test circle name validation: 1 char, 2 chars, 3 chars (boundary)
- File: `test/unit/validation.test.ts`

### Files affected
- `test/unit/newsletter-idempotency.test.ts` (new)
- `test/unit/cycle-id.test.ts` (new)
- `test/unit/video-auth.test.ts` (new)
- `test/unit/validation.test.ts` (new)

## Dependencies
- [ ] #155 (P0 bugs) — need idempotency and cycleId logic implemented to test
- [ ] #156 (locked status) — status derivation logic to test
- [ ] #157 (video auth) — auth checks to test
- [ ] #160 (validation) — validation logic to test

## Effort Estimate
- Size: M
- Parallel: false (depends on implementation tasks completing first)

## Definition of Done
- [ ] All new test files created and passing
- [ ] All existing 926 tests still pass
- [ ] `npm test` exits with 0
- [ ] Tests cover the core logic, not just happy paths

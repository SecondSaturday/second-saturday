---
name: Extend memberships schema and update existing queries
status: open
created: 2026-02-10T18:05:11Z
updated: 2026-02-10T18:15:11Z
github: https://github.com/SecondSaturday/second-saturday/issues/51
depends_on: []
parallel: false
conflicts_with: [52, 53]
---

# Task: Extend memberships schema and update existing queries

## Description
Add `leftAt` and `blocked` fields to the memberships table in `convex/schema.ts`. Update all existing queries and mutations in `convex/memberships.ts` and `convex/circles.ts` to filter out inactive members (those with `leftAt` set). Update `joinCircle` to handle rejoin (clear `leftAt`) and block check.

## Acceptance Criteria
- [ ] `leftAt: v.optional(v.number())` added to memberships schema
- [ ] `blocked: v.optional(v.boolean())` added to memberships schema
- [ ] `getCircleMembers` filters out members where `leftAt` is set
- [ ] `getMembershipCount` only counts active members
- [ ] `joinCircle` handles rejoin by clearing `leftAt` on existing membership
- [ ] `joinCircle` rejects blocked members with clear error message
- [ ] `getCirclesByUser` in circles.ts filters out left memberships
- [ ] `requireMembership` helper rejects members who have left

## Technical Details
- Files: `convex/schema.ts`, `convex/memberships.ts`, `convex/circles.ts`
- Add optional fields so existing data remains valid
- Active member = membership where `leftAt === undefined`
- Rejoin logic: find existing membership with `leftAt` set, patch to clear `leftAt` and update `joinedAt`

## Dependencies
- [ ] None â€” this is the foundation task

## Effort Estimate
- Size: S
- Hours: 2
- Parallel: false (other tasks depend on this)

## Definition of Done
- [ ] Code implemented
- [ ] Schema deploys successfully to Convex
- [ ] Existing functionality unbroken
- [ ] Tests written and passing
